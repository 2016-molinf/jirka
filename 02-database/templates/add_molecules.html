{% extends '_layout.html' %}
{% load staticfiles %}

{% block staticfiles %}
    {{ block.super }}
    <script src="{% static "js/ChemDoodleWeb.js" %}"></script>
    <script src="{% static "js/ChemDoodleWeb-uis.js" %}"></script>

    <link href="{% static "css/ChemDoodleWeb.css" %}" rel="stylesheet" type="text/css">
    <link href="{% static "css/jquery-ui-1.10.3.custom.css" %}" rel="stylesheet" type="text/css">
    <link href="{% static "css/add_molecules.css" %}" rel="stylesheet" type="text/css">
{% endblock %}

{% block title %}Add molecule{% endblock %}

{% block content %}
    <h2>Add molecule</h2>

    <div id="div-adding-wrapper">
        <div id="div-chemdoodle">
            {% comment %}
            <form id="form-add_molecules" method="POST">
                {% csrf_token %}
                {{ form.as_p }}
            </form>

            <div id="div-arrows">
                <arrow>&uarr;</arrow><arrow>&darr;</arrow>
            </div>
            {% endcomment %}

            <p>You can draw structure:</p>

            <canvas id="canvas-chemdoodle"></canvas>

            <input id="input-smiles" type="text" readonly="readonly" />

            <div id="div-buttons">
                <button id="button-add" type="submit">Add</button>
                <!--<button id="button-reset" type="reset">Reset</button>-->
                <button id="button-smiles" type="button">Show SMILES</button>
            </div>
        </div>

        <div id="div-import">
            <p>You can import file containing molecules (currently supports SMILES, one per line):</p>
            <form action="/api/uploadMolecules" method="post" id="form-import" enctype="multipart/form-data">
                {% csrf_token %}
                <input id="input-file" type="file" />
                <button id="button-import" type="submit">Import</button>
            </form>
        </div>
    </div>

    <div id="div-info"></div>

{% endblock %}

{% block scripts %}
    {{ block.super }}

    <script>
        var sketcher = new ChemDoodle.SketcherCanvas('canvas-chemdoodle', 500, 300, {useServices: true, oneMolecule: true});

        function toggleLoad(mode)
        {
            if (mode)
            {
                $("#div-info").html("<div id='div-loader'><img src='{% static 'image/gear.gif' %}' alt='Loading...' /></div>");
                $("#div-buttons #button-add").prop('disabled', true);
            }
            else
            {
                $("#div-info #div-loader").remove();
                $("#div-buttons #button-add").prop('disabled', false);
            }
        }

        function showInfo(result)
        {
            console.log(result);

            $("#div-info").html(`
                <table id="table-info" cellpadding="10">
                    <thead>
                        <tr>
                            <th>SMILES</th>
                            <th>success</th>
                            <th>error</th>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            `);

            $.each(result, function()
            {
                if (this.success)
                {
                    var tr_class = "success";
                }
                else
                {
                    var tr_class = "error";
                }

                if (this.error)
                {
                    var error = this.error;
                }
                else
                {
                    var error = "";
                }

                $("#table-info tbody").append(`
                    <tr class="{0}">
                        <td style="text-align: left;">{1}</td>
                        <td>{2}</td>
                        <td>{3}</td>
                    </tr>
               `.format(tr_class, this.smiles, this.success, error));
            });
        }

        $("#button-add").click(function()
        {
            toggleLoad(true);

            var molfile = ChemDoodle.writeMOL(sketcher.getMolecule());

            if (molfile != "")
            {
                $.ajax({
                    url: "/api/addMolecule",
                    method: "POST",
                    data: {molfile: ChemDoodle.writeMOL(sketcher.getMolecule())},
                    success: function(result)
                    {
                        if (result[0].smiles)
                        {
                            $("#input-smiles").val(result[0].smiles);
                        }

                        showInfo(result);
                    }
                });
            }
            else
            {
                $("#div-info").html("<p class='error'>Cannot add empty molecule!</p>");
            }

            toggleLoad(false);
        });

        $("#button-smiles").click(function()
        {
            $.ajax({
                url: "/api/molConverter",
                method: "POST",
                data: {data: ChemDoodle.writeMOL(sketcher.getMolecule()), format_from: "molfile", format_to: "smiles"},
                success: function(result)
                {
                    if (result.success)
                    {
                        $("#input-smiles").val(result.data);
                    }
                    else
                    {
                        $("#input-smiles").val(result.error);
                    }
                }
            });
        });

        $('#form-import').submit(function(e)
        {
            e.preventDefault();
            var fd = new FormData();
            fd.append('file', $('#input-file')[0].files[0]);

            $.ajax({
                url: '/api/uploadMolecules',
                type: 'POST',
                data: fd,
                cache: false,
                processData: false,
                contentType: false,
                success: function(result)
                {
                    showInfo(result);
                }
            });
        });
    </script>
{% endblock %}